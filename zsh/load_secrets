# Loads API keys and secrets from macOS Keychain into shell environment.
# Values are stored in Keychain (never in files); only env var names are
# tracked in zsh/secrets.list, which is safe to commit to git.
#
# Usage:
#   secret-set VAR_NAME value   — store or update a secret in Keychain
#   secret-get VAR_NAME         — print a secret's value
#   secret-del VAR_NAME         — remove a secret from Keychain
#   secret-list                 — list all tracked env var names

_SECRETS_SERVICE="dotfiles-env"
_SECRETS_LIST="${HOME}/.config/zsh/secrets.list"

# Store or update a secret in Keychain
secret-set() {
  local name="$1" value="$2"
  if [[ -z "$name" || -z "$value" ]]; then
    echo "Usage: secret-set VAR_NAME value" >&2
    return 1
  fi
  # Delete existing entry silently before adding (add fails if key exists)
  security delete-generic-password -s "$_SECRETS_SERVICE" -a "$name" &>/dev/null
  security add-generic-password -s "$_SECRETS_SERVICE" -a "$name" -w "$value"
  # Export immediately into current session
  export "$name"="$value"
  echo "Secret '$name' saved to Keychain."
}

# Print a secret's value from Keychain
secret-get() {
  local name="$1"
  if [[ -z "$name" ]]; then
    echo "Usage: secret-get VAR_NAME" >&2
    return 1
  fi
  security find-generic-password -s "$_SECRETS_SERVICE" -a "$name" -w 2>/dev/null \
    || { echo "Secret '$name' not found in Keychain." >&2; return 1; }
}

# Remove a secret from Keychain
secret-del() {
  local name="$1"
  if [[ -z "$name" ]]; then
    echo "Usage: secret-del VAR_NAME" >&2
    return 1
  fi
  security delete-generic-password -s "$_SECRETS_SERVICE" -a "$name" &>/dev/null \
    && echo "Secret '$name' removed from Keychain." \
    || echo "Secret '$name' not found in Keychain." >&2
  unset "$name"
}

# List all tracked env var names from secrets.list
secret-list() {
  if [[ ! -f "$_SECRETS_LIST" ]]; then
    echo "No secrets.list found at $_SECRETS_LIST"
    return
  fi
  echo "Tracked secrets (names only — values are in Keychain):"
  grep -v '^\s*#' "$_SECRETS_LIST" | grep -v '^\s*$' | while read -r name; do
    if security find-generic-password -s "$_SECRETS_SERVICE" -a "$name" -w &>/dev/null; then
      echo "  ✔ $name"
    else
      echo "  ✘ $name (not yet stored — run: secret-set $name <value>)"
    fi
  done
}

# At shell startup: read secrets.list and export each key from Keychain
if [[ -f "$_SECRETS_LIST" ]]; then
  while IFS= read -r _secret_name || [[ -n "$_secret_name" ]]; do
    # Skip blank lines and comments
    [[ -z "$_secret_name" || "$_secret_name" == \#* ]] && continue
    _secret_val="$(security find-generic-password -s "$_SECRETS_SERVICE" -a "$_secret_name" -w 2>/dev/null)"
    if [[ -n "$_secret_val" ]]; then
      export "$_secret_name"="$_secret_val"
    fi
  done < "$_SECRETS_LIST"
  unset _secret_name _secret_val
fi
